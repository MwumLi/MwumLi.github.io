# js 的作用域链及标识符的查找

2015-09-30 15:33:25 By MwumLi

---


JavaScript 中有一个很重要的概念叫执行环境  
执行环境定义了变量或函数作用范围, 即可使用的范围, 所以也可以被称作**作用域**  

每一个作用域都有一个与之关联的变量对象, 用来访问当前作用域下的变量和对象  
这里我们简称为 **作用域对象**  

在 Web 浏览器中, 全局作用域对象是 `window` 对象  

JavaScript 中使用函数作为作用范围的划分  
因此, 每一个函数对象都是自己作用域下的作用域对象  

**对于作用域对象属性的访问**, 我们完全可以使用 `obj_name.attr_name` 或 `obj_name[attr_name]` 来访问  
对于在当前作用域中 js 代码中, 我们可以使用 `this` 来代替当前作用域对象, 来访问属性  

## 作用域链  

作用域链可以保证我们代码中标识符有序地被访问  

当代码在一个环境中执行时, 会创建这个环境对象的一个作用域链(scope chain) :  

1. 作用域链的前端始终是当前执行环境的变量对象  

2. 作用域链中的下一个变量对象来自包含环境  

3. 重复第 2 步, 直到延续到全局执行环境  

4. 全局执行环境的变量对象始终都是作用域链的最后一个对象  


这里有个不恰当的比喻 : 人体皮肤 --> 衣服 --> 空气 --> 地球  
从内部依次向外, 人体皮肤就是作用域链的前端, 而地球就是我们全局作用域对象  

还是来看看下面这段代码吧 :  
(代码永远比任何语言更有说服力)  

	var gift = "apple";
	function changeGift() {
		var aGift = "cake";

		function swapGift() {
			var temp = aGift;
			aGift = gift;
			gift = temp;
		}
		swapGift();
	}

	changeColor();
	console.log("My gift is "+gift);


这里是它的作用域链 :  

	window
	  |
	  |--gift
	 ...	//这里之所以用省略号, 是因为全局作用域对象默认就有很多预定义的变量  
	  |
	  |--changeGift()
	         |
			 |--aGift
			 |--swapGift()
			       |
				   |--temp

我们可以清楚的看到有三个作用域 : `swapGift()`的局部作用域 、`changeGift()`的局部作用域和 `window` 所代表的全局作用域   


## 查找标识符  

标识符的解析是沿着作用域链一级一级向上搜索标识符(作用域链的前端开始, 逐级向后回溯)  

上面这个例子中, 在执行 `aGift = gift` 时, 我们需要去寻找 `gift`, 此时 :  

1. 首先在 `swapGift()` 的局部作用域查找 `gift`, 未曾发现 `gift`  

2. 然后又沿着作用域链去 `changeGift()` 的局域作用域查找 `gift`, 未曾发现 `gift`  

3. 沿着作用域链来到全局作用域查找 `gift`, 找到了 `gift`, 搜索结束  

